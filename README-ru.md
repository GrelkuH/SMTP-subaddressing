### Описание задачи:
Необходимо пересылать почтовые сообщения в почтовые системы которые не поддерживают subaddressing, например, Exchange OnPremise. При этом необходимо сохранить возможность отправки в Интернет без изменения SMTP-адреса

Для настройки Postfix так, чтобы он ретранслировал почту с использованием subaddressing (адресов с плюсом, например, `user+foo@example.com`) внутри вашей почтовой инфраструктуры на адрес без знака плюса, а при отправке в интернет оставлял адрес без изменений, можно воспользоваться следующим подходом:

### 1. Настройка `canonical_maps` для удаления subaddressing внутри инфраструктуры

Файл `canonical_maps` позволяет преобразовывать адреса перед их обработкой. Создайте файл, например, `/etc/postfix/canonical`, и добавьте в него правило для удаления subaddressing:

```plaintext
/^([^+]+)\+.*@example\.com$/\1@example.com/
```

Это регулярное выражение удаляет часть адреса после знака `+` для домена `example.com`.

Затем добавьте этот файл в конфигурацию Postfix:

```bash
postmap /etc/postfix/canonical
```

И укажите его в `main.cf`:

```bash
canonical_maps = regexp:/etc/postfix/canonical
```

### 2. Настройка `sender_canonical_maps` для отправки в интернет без изменений

Чтобы при отправке в интернет адреса оставались без изменений, убедитесь, что `sender_canonical_maps` не применяется к исходящим письмам. Если у вас уже есть настройки в `sender_canonical_maps`, убедитесь, что они не изменяют адреса с subaddressing.

### 3. Настройка `relay_domains` и `transport_maps`

Убедитесь, что Postfix настроен на ретрансляцию почты для вашего домена. В `main.cf` должны быть указаны:

```bash
relay_domains = example.com
transport_maps = hash:/etc/postfix/transport
```

В файле `/etc/postfix/transport` укажите, как обрабатывать почту для вашего домена:

```plaintext
example.com smtp:[internal-smtp-server]:25
```

Где `internal-smtp-server` — это ваш внутренний SMTP-сервер.

### 4. Перезагрузка Postfix

После внесения изменений перезагрузите Postfix:

```bash
systemctl reload postfix
```

### Итог

Теперь Postfix будет:

1. Принимать письма на адреса с subaddressing (например, `user+foo@example.com`).
2. Преобразовывать их в `user@example.com` для внутренней обработки.
3. Отправлять письма в интернет без изменений, сохраняя оригинальный адрес.

Этот подход позволяет гибко управлять адресацией внутри вашей почтовой инфраструктуры, сохраняя при этом совместимость с внешними системами.
